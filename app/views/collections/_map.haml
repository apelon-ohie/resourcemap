.left.w33.h50
  <!-- ko if: !loadingSite() -->

  -# Collections
  <!-- ko if: !currentCollection() && !editingSite() -->
  .tableheader.w33
    My Collections
  .tablescroll
    %table.GralTable.CleanTable
      %tbody
        <!-- ko foreach: collections -->
        %tr
          %td
            %div
              = ko_check_box_tag :checked
              %span{ko(:text => :name)}
            %button.farrow{ko(:click => '$root.enterCollection'), :type => :button}
        <!-- /ko -->
  .tablebottom{ko(:click => '$root.createCollection'), :style => 'cursor: pointer'}
    %button.cadd{:type => "button"}
    Create Collection
  <!-- /ko -->

  -# Sites template
  %script{:type => "text/html", :id => "map-sites-template"}
    <!-- ko foreach: sites -->
    %tr{ko(:css => "{closed: group() && !expanded(), opened: group() && expanded, active: $data == $root.selectedSite()}")}
      %td
        %div
          <!-- ko if: group() -->
          %a{ko(:click => '$root.toggleSite', :style => "{marginLeft: '' + ((level() - 1) * 20) + 'px'}"), :href => 'javascript:void(0)'}
            <!-- ko if: expanded() -->
            = image_tag "http://theme.instedd.org/theme/images/icons/18/black/folder_open.png"
            <!-- /ko -->
            <!-- ko if: !expanded() -->
            = image_tag "http://theme.instedd.org/theme/images/icons/18/black/folder.png"
            <!-- /ko -->
          %span{ko(:text => :name, :click => '$root.selectSite'), :style => 'cursor: pointer'}
          <!-- /ko -->

          <!-- ko if: !group() -->
          %p{ko(:style => "{marginLeft: '' + (10 + (level() - 1) * 20) + 'px'}", :click => '$root.selectSite'), :style => 'cursor: pointer'}
            %span.stat-r
            %span{ko(:text => :name)}
          <!-- /ko -->
        %button.farrow{ko(:click => '$root.editSite'), :type => "button"}
    <!-- ko if: expanded -->
    <!-- ko template: {name: 'map-sites-template', with: sites} -->
    <!-- /ko -->
    <!-- ko if: group() && hasMoreSites() && !loadingSites()-->
    %tr
      %td.loadmore
        = link_to "Load more sites...", 'javascript:void()', 'data-bind' => kov(:click => :loadMoreSites, :style => "{marginLeft: '' + (30 + (level() - 1) * 20) + 'px'}")
    <!-- /ko -->
    <!-- ko if: group() && hasMoreSites() && loadingSites()-->
    %tr
      %td.loadmore
        %span{ko(:style => "{marginLeft: '' + (20 + (level() - 1) * 20) + 'px'}")} Loading...
    <!-- /ko -->
    <!-- /ko -->
    <!-- /ko -->

  -# Collection sites
  <!-- ko if: !editingSite() -->
  <!-- ko with: currentCollection -->
  .tableheader.w33
    %button.fleft{ko(:click => '$root.goToRoot'), :type => 'button'}
    %span.i18b-groupChat
    %span{ko(:text => :name)}
    %button.fconfiguration.right{ko(:click => '$root.editCollection'), :type => 'button'}
  .tablescroll
    %table.GralTable.CleanTable
      %tbody
        <!-- ko template: {name: 'map-sites-template', with: $data} -->
        <!-- /ko -->
        <!-- ko if: hasMoreSites() && !loadingSites()-->
        %tr
          %td.loadmore
            = ko_link_to "Load more sites...", :loadMoreSites, :style => 'margin-left: 23px'
        <!-- /ko -->
        <!-- ko if: hasMoreSites() && loadingSites()-->
        %tr
          %td.loadmore Loading...
        <!-- /ko -->
  .tablebottom
    <!-- ko if: !$root.selectedSite() || $root.selectedSite().group() -->
    Add
    %button.ffolder{ko(:click => '$root.createGroup')} Group
    or
    %button.flocation{ko(:click => '$root.createSite')} Site
    <!-- ko if: $root.selectedSite() -->
    at
    %span{ko(:text => '$root.selectedSite().name()')}
    <!-- /ko -->
    <!-- /ko -->
  <!-- /ko -->
  <!-- /ko -->

  -# New Group form
  %form{ko(:with => :newGroup, :submit => '$root.saveSite', :attr => "{'action': '#' + ($root.currentCollection() ? $root.currentCollection().id() : '')}"), :style => 'display:inline'}
    .tableheader.w33
      %button.fleft{ko(:click => '$root.exitSite'), :type => 'button'}
      %span.i18b-groupChat
      %span New Group
      <!-- ko if: $root.selectedSite() && !id() -->
      %span at
      %span{ko(:text => '$root.selectedSite().name()')}
      <!-- /ko -->
    .tablescroll
      %table.GralTable.CleanTable
        %tbody
          %tr
            %td
              %p
                = label_tag :name, "Name:"
                = text_field_tag :name, '', :placeholder => 'Enter new group name', 'data-bind' => kov(:value => :name, :valueUpdate => "'afterkeydown'", :hasfocus => true)
              %p
                %label Mode:
                = select_tag :location_mode, options_for_select(['automatic', 'manual', 'none']), 'data-bind' => kov(:value => :locationMode)
              %p{ko(:visible => "locationMode() == 'manual'")}
                %label Location:
                = ko_text_field_tag :locationText, :event => '{keydown: newLocationKeyPress, blur: moveLocation}'
    .tablebottom
      %button.grey{ko(:enable => :valid), :type => 'submit'} Done
      %span{ko(:click => '$root.exitSite')} Cancel

  -# New Site form
  %form{ko(:with => :newSite, :submit => '$root.saveSite', :attr => "{'action': '#' + ($root.currentCollection() ? $root.currentCollection().id() : '')}"), :style => 'display:inline'}
    .tableheader.w33
      %button.fleft{ko(:click => '$root.exitSite'), :type => 'button'}
      %span.i18b-groupChat
      %span New Site
      <!-- ko if: $root.selectedSite() && !id() -->
      %span at
      %span{ko(:text => '$root.selectedSite().name()')}
      <!-- /ko -->
    .tablescroll
      %table.GralTable.CleanTable
        %tbody
          %tr
            %td
              %p
                = label_tag :name, "Name:"
                = text_field_tag :name, '', :placeholder => 'Enter new site name', 'data-bind' => kov(:value => :name, :valueUpdate => "'afterkeydown'", :hasfocus => true)
              %p
                %label Location:
                = ko_text_field_tag :locationText, :event => '{keydown: newLocationKeyPress, blur: moveLocation}'
              %hr
              <!-- ko foreach: $root.currentCollection().fields() -->
              %p
                = label_tag '', '', ko(:attr => "{'for': code}", :text => "name() + ':'")
                <!-- ko if: kind() == 'text' || kind() == 'numeric' -->
                = ko_text_field_tag :value, :hasfocus => true
                <!-- /ko -->
                <!-- ko if: kind() == 'selectOne' -->
                %select{ko(:value => :value, :options => :options)}
                <!-- /ko -->
              <!-- /ko -->
    .tablebottom
      %button.grey{ko(:enable => :valid), :type => 'submit'} Done
      %span{ko(:click => '$root.exitSite')} Cancel

  -# Show Group form
  %form{ko(:with => :showGroup, :submit => '$root.saveSite', :attr => "{'action': '#' + ($root.currentCollection() ? $root.currentCollection().id() : '')}"), :style => 'display:inline'}
    .tableheader.w33
      %button.fleft{ko(:click => '$root.exitSite'), :type => 'button'}
      %span.i18b-groupChat
      %span{ko(:text => :name)}
    .tablescroll
      %table.GralTable.CleanTable
        %tbody
          %tr
            %td
              %p
                %label Name:
                %span{ko(:text => :name, :visible => '!editingName()', :click => 'editName'), :style => 'cursor: pointer'}
                <!-- ko if: editingName() -->
                = ko_text_field_tag :name, :visible => 'editingName()', :hasfocus => true, :event => '{keydown: nameKeyPress, blur: saveName}'
                <!-- /ko -->
              %p
                %label Mode:
                %span{ko(:text => :locationMode, :click => 'editLocationMode', :visible => '!editingLocationMode()'), :style => 'cursor: pointer'}
                = select_tag :location_mode, options_for_select(['automatic', 'manual', 'none']), 'data-bind' => kov(:value => :locationMode, :visible => :editingLocationMode, :hasfocus => true, :event => '{change: saveLocationMode, blur: saveLocationMode}')
              %p{ko(:visible => "locationMode() == 'manual'")}
                %label Location:
                %span{ko(:text => :locationText, :visible => '!editingLocation()', :click => 'editLocation'), :style => 'cursor: pointer'}
                <!-- ko if: editingLocation() -->
                = ko_text_field_tag :locationText, :visible => :editingLocation, :hasfocus => true, :event => '{keydown: locationKeyPress, blur: saveLocation}'
                <!-- /ko -->
    .tablebottom
      = link_to 'Delete Group', 'javascript:void()', :class => 'icon fdelete black', 'data-bind' => kov(:click => '$root.deleteSite')

  -# Show Site form
  %form{ko(:with => :showSite, :submit => '$root.saveSite', :attr => "{'action': '#' + ($root.currentCollection() ? $root.currentCollection().id() : '')}"), :style => 'display:inline'}
    .tableheader.w33
      %button.fleft{ko(:click => '$root.exitSite'), :type => 'button'}
      %span.i18b-groupChat
      %span{ko(:text => :name)}
    .tablescroll
      %table.GralTable.CleanTable
        %tbody
          %tr
            %td
              %p
                %label Name:
                %span{ko(:text => :name, :visible => '!editingName()', :click => 'editName'), :style => 'cursor: pointer'}
                <!-- ko if: editingName() -->
                = ko_text_field_tag :name, :visible => 'editingName()', :hasfocus => true, :event => '{keydown: nameKeyPress, blur: saveName}'
                <!-- /ko -->
              %p
                %label Location:
                %span{ko(:text => :locationText, :visible => '!editingLocation()', :click => 'editLocation'), :style => 'cursor: pointer'}
                <!-- ko if: editingLocation() -->
                = ko_text_field_tag :locationText, :visible => :editingLocation, :hasfocus => true, :event => '{keydown: locationKeyPress, blur: saveLocation}'
                <!-- /ko -->
              %hr
              <!-- ko foreach: parentCollection().fields() -->
              %p
                %label{ko(:text => "name() + ':'")}
                <!-- ko if: value() -->
                %span{ko(:text => :value, :visible => '!editing()', :click => 'edit'), :style => 'cursor:pointer'}
                <!-- /ko -->
                <!-- ko if: !value() -->
                %span{ko(:visible => '!editing()', :click => 'edit'), :style => 'color:grey;cursor:pointer'} (no value)
                <!-- /ko -->
                <!-- ko if: editing() && (kind() == 'text' || kind() == 'numeric') -->
                = ko_text_field_tag :value, :hasfocus => true, :event => '{keydown: keyPress, blur: save}'
                <!-- /ko -->
                <!-- ko if: editing() && kind() == 'selectOne' -->
                %select{ko(:value => :value, :options => :options, :event => '{change: save, blur: save}')}
                <!-- /ko -->
              <!-- /ko -->
    .tablebottom
      = link_to 'Delete Site', 'javascript:void()', :class => 'icon fdelete black', 'data-bind' => kov(:click => '$root.deleteSite')
  <!-- /ko -->

  -# Loading Site...
  %form{ko(:visible => :loadingSite)}
    .tableheader.w33
      %button.fleft
      %span.i18b-groupChat
      %span Loading...
.right
  .mapheader
    %span{ko(:visible => 'sitesCount() == 1')} 1 site on map
    %span{ko(:text => "'' + sitesCount() + ' sites on map'", :visible => 'sitesCount() != 1')}
    -#%span.alert 5 alerts
    %button.icon_button.ftable.right{ko(:click => '$root.showTable', :css => "{active: !$root.showingMap()}")}
    %button.icon_button.fmap.right{ko(:click => '$root.showMap', :css => "{active: $root.showingMap()}")}
    %br{:clear => :all}
  #map
