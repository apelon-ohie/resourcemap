= render 'tabs'

- content_for :head do
  :javascript
    $(function() { initMemberships(#{current_user.id}, #{collection.id}, #{collection_admin?}, #{collection.layers.map{|x| {id: x.id, name: x.name}}.to_json}); });
  :css
    table.GralTable td.center { text-align: center; }


.tabsline
  #memberships-main.hidden-until-loaded
    %h2 Members
    %p Manage who can see this collection and who can read/write its layers
    %br/

    Show memberships grouped by:
    %select{ko(options: :groupByOptions, value: :groupBy)}
    %br/
    %br/

    <!-- ko if: groupBy() == 'Users' -->
    .tablewrapp
      %table.GralTable
        %tr
          - if collection_admin?
            %th{:style => 'min-width:120px'}
          %th Name
          %th Admin?
          %th Can Read?
          %th Can Update?
          %th
        <!-- ko foreach: memberships -->
        %tr{:style => 'height:32px'}
          - if collection_admin?
            %td
          %td{ko(click: :toggleExpanded), style: 'cursor:pointer'}
            %img{ko(attr: {src: "'#{InsteddRails.url}/theme/images/icons/misc/black/arrow' + (expanded() ? 'Down' : 'Right') + '.png'"}), style: "position:relative;top:1px", width: 11, height: 11}
            %span{ko(text: :userDisplayName)}
          - if collection_admin?
            <!-- ko if: isCurrentUser() -->
            %td.center{ko(html: :adminUI)}
            <!-- /ko -->
            <!-- ko if: !isCurrentUser() -->
            %td.center
              %input{ko(checked: :admin), type: :checkbox}
            <!-- /ko -->
          - else
            %td.center{ko(html: :adminUI)}

          <!-- ko if: !$root.admin() || isCurrentUser() -->
          %td.center{ko(text: :allReadUI)}
          %td.center{ko(text: :allWriteUI)}
          <!-- /ko -->
          <!-- ko if: $root.admin() && !isCurrentUser() -->
          %td.center
            %span{ko(attr: {:class => :allRead}, click: :toggleAllRead)}
          %td.center
            %span{ko(attr: {:class => :allWrite}, click: :toggleAllWrite)}
          <!-- /ko -->
          %td
            - if collection_admin?
              <!-- ko if: !isCurrentUser() -->
              = ko_link_to 'delete', '$root.destroyMembership', class: 'icon fdelete black'
              <!-- /ko -->
        <!-- ko if: expanded -->
        <!-- ko foreach: membershipLayerLinks -->
        %tr{:style => 'height:32px'}
          - if collection_admin?
            %td
          %td
            %span{ko(text: 'layer.name()'), style: 'margin-left:20px'}
          %td
          <!-- ko if: !$root.admin() || membership.isCurrentUser() -->
          %td.center{ko(text: :canReadUI)}
          %td.center{ko(text: :canWriteUI)}
          <!-- /ko -->
          <!-- ko if: $root.admin() && !membership.isCurrentUser() -->
          %td.center
            %input{ko(checked: :canRead), type: :checkbox}
          %td.center
            %input{ko(checked: :canWrite), type: :checkbox}
          <!-- /ko -->
          %td
        <!-- /ko -->
        <!-- /ko -->
        <!-- /ko -->
        - if collection_admin?
          %tr{:style => 'height:32px'}
            %td
              %button.cadd#add_member Add member
            %td#autocomplete_container{style: 'width: 470px;'}
              = text_field_tag :member_email, '', :placeholder => 'Search by email...'
            %td
            %td
    <!-- /ko -->

    <!-- ko if: groupBy() == 'Layers' -->
    .tablewrapp
      %table.GralTable
        %tr
          %th Name
          %th Can Read?
          %th Can Update?
        <!-- ko foreach: layers -->
        %tr{:style => 'height:32px'}
          %td{ko(click: :toggleExpanded), style: 'cursor:pointer'}
            %img{ko(attr: {src: "'#{InsteddRails.url}/theme/images/icons/misc/black/arrow' + (expanded() ? 'Down' : 'Right') + '.png'"}), style: "position:relative;top:1px", width: 11, height: 11}
            %span{ko(text: :name)}
          <!-- ko if: !$root.admin() -->
          %td.center{ko(text: :allReadUI)}
          %td.center{ko(text: :allWriteUI)}
          <!-- /ko -->
          <!-- ko if: $root.admin() -->
          %td.center
            %span{ko(attr: {:class => :allRead}, click: :toggleAllRead)}
          %td.center
            %span{ko(attr: {:class => :allWrite}, click: :toggleAllWrite)}
          <!-- /ko -->
        <!-- ko if: expanded -->
        <!-- ko foreach: membershipLayerLinks -->
        %tr{:style => 'height:32px'}
          %td
            %span{ko(text: 'membership.userDisplayName()'), style: 'margin-left:20px'}
          <!-- ko if: !$root.admin() || membership.isCurrentUser() -->
          %td.center{ko(text: :canReadUI)}
          %td.center{ko(text: :canWriteUI)}
          <!-- /ko -->
          <!-- ko if: $root.admin() && !membership.isCurrentUser() -->
          %td.center
            %input{ko(checked: :canRead), type: :checkbox}
          %td.center
            %input{ko(checked: :canWrite), type: :checkbox}
          <!-- /ko -->
          %td
        <!-- /ko -->
        <!-- /ko -->
        <!-- /ko -->
    <!-- /ko -->
