.left.w40.h50
  <!-- ko if: !loadingSite() -->

  -# Collections
  <!-- ko if: !currentCollection() && !editingSite() -->
  .tableheader.w40
    %div{style: 'padding-top:6px;padding-left:15px'} My Collections

  .tablescroll
    %table.GralTable.CleanTable
      %tbody
        <!-- ko foreach: collections -->
        %tr
          %td
            %div
              %input{ko(checked: :checked), type: :checkbox, style: 'position:relative;top:3px'}
              %span{ko(text: :name, click: '$root.enterCollection'), style: 'cursor: pointer'}
            <!-- ko if: currentSnapshot -->
            .snapshot_on.right{style: 'padding-right:0'}
              .i18g-snapshot
              %button.farrow{ko(click: '$root.enterCollection'), type: :button,  style: 'float:none'}
            .clear
            <!-- /ko -->
            <!-- ko if: !currentSnapshot -->
            %button.farrow{ko(click: '$root.enterCollection'), type: :button}
            <!-- /ko -->
        <!-- /ko -->
    %br{:clear => "all"}/
    #profile-main{style: 'display:none'}
      .box.plain.orange{ko(visible: 'collections().length < 1 || (!$root.isExist())'), :style => 'padding:5px; display:none'}
        <!-- ko if: collections().length < 1 -->
        .sbox.grey.StateDisplay{style: 'margin: 0px;padding: 0px;'}
          .values{style: 'padding: 0px;margin: 4px 0 4px 0;font-size: 12px;line-height: 12px;'}
            .L
              %span No collections
              %span created
            .R
              %span 0%
              %span completed
            %br{:clear => "all"}/
            .M{style: 'padding: 0px'}
              %span.Fill{style: 'width: 5px'}/
          %button.orange{ko(click: '$root.createCollection'), :type => "button", style: 'padding: 0px; cursor: pointer'} Start creating
        <!-- /ko -->
        .space{ko(visible: 'collections().length < 1 && (!$root.isExist())'),height: '4px'}
        .sbox.grey.StateDisplay{ko(visible: '!$root.isExist()'), style: 'margin: 0px;padding: 0px;'}
          .values{style: 'padding: 0px;margin: 4px 0 4px 0;font-size: 12px;line-height: 12px;'}
            .L
              %span No gateways
              %span created
            .R
              %span 0%
              %span completed
            %br{:clear => "all"}/
            .M{style: 'padding: 0px'}
              %span.Fill{style: 'width: 5px'}/
          %button.orange{:onClick => "window.location='/gateways';return false;", :type => "button", style: 'padding: 0px'} Start creating

  .tablebottom{ko(click: '$root.createCollection'), style: 'cursor: pointer'}
    %button.cadd{type: "button"}
    %span.createCollection Create Collection
  <!-- /ko -->

  -# Collection sites
  <!-- ko if: !editingSite() -->
  <!-- ko with: currentCollection -->
  .tableheader.w40
    %button.pback{ko(click: '$root.goToRoot'), type: 'button'}
    %span.i18b-groupChat
    %span{ko(text: :name)}
    %button.fconfiguration.right{ko(click: '$root.editCollection'), type: 'button', style: 'margin-right:9px'}


  .tablescroll
    %table.GralTable.CleanTable
      %tbody
        <!-- ko if: !isSearch() && $root.groupBy().esCode != '' -->
        <!-- ko template: {name: 'map-hierarchy-items-template', with: $data} -->
        <!-- /ko -->
        <!-- /ko -->
        <!-- ko template: {name: 'map-sites-template', with: $data} -->
        <!-- /ko -->
        <!-- ko if: hasMoreSites() && !loadingSites()-->
        %tr
          %td.loadmore
            = ko_link_to "Load more sites...", :loadMoreSites, style: 'margin-left: 23px'
        <!-- /ko -->
        <!-- ko if: hasMoreSites() && loadingSites()-->
        %tr
          %td.loadmore Loading...
        <!-- /ko -->
  .tablebottom
    <!-- ko if: !currentSnapshot-->
    %button.flocation{ko(click: '$root.createSite')} Create Site
    <!-- /ko -->

  <!-- /ko -->
  <!-- /ko -->

  -# New Site or Edit Site form
  <!-- ko if: newOrEditSite -->
  %form{ko(with: :newOrEditSite, submit: '$root.saveSite'), action: '#/null', method: :post, style: 'display:inline-block;width:100%'}
    .tableheader.w40
      %button.pback{ko(click: '$root.exitSite'), type: 'button'}
      %span.i18b-groupChat
      <!-- ko if: inEditMode() -->
      %span{ko(text: :name)}
      <!-- /ko -->
      <!-- ko if: !inEditMode() -->
      %span New Site
      <!-- /ko -->
    .tablescroll
      %table
        %tbody
          %tr
            %td
              %div
                = label_tag :name, "Name:"
                = text_field_tag :name, '', placeholder: 'Enter new site name', class: 'w20 right', 'data-bind' => kov(value: :name, valueUpdate: :afterkeydown, hasfocus: true, event: {blur: :tryGeolocateName}), :autofocus => true
                .clear
              %div
                %label Location:
                = ko_text_field_tag :locationText, event: {keydown: :newLocationKeyPress, blur: :moveLocation}, html: {class: 'ux-search right w20', placeholder: 'Search / Drag the pin'}
                .clear
              / ko if: collection.readable($data)
              <!-- ko foreach: $root.currentCollection().layers() -->
              %div
                %img{ko(attr: {src: "'#{InsteddRails.url}/theme/images/icons/misc/grey/arrow' + (expanded() ? 'Down' : 'Right') + '.png'"}, click: :toggleExpand), style: "position:relative;top:1px;cursor:pointer", width: 11, height: 11}
                %span{ko(text: :name, click: :toggleExpand), style: 'font-weight:bold;color:grey;cursor:pointer'}
              <!-- ko if: expanded() -->
              <!-- ko foreach: fields -->
              %div
                = label_tag '', '', ko(attr: {:for => :esCode}, text: "name + ':'")
                <!-- ko if: !writeable -->
                %span.value{ko(text: :valueUI)}
                <!-- /ko -->
                <!-- ko if: writeable -->
                - Field::Kinds.each do |kind|
                  <!-- ko if: kind == '#{kind}' -->
                  = render partial: field_edit_view(kind), locals: { single_editing_mode: false }
                  <!-- /ko -->
                <!-- /ko -->
              <!-- /ko -->
              <!-- /ko -->
              <!-- /ko -->
              / /ko
    .tablebottom
      %button.grey{ko(enable: :valid), type: 'submit'} Done
      %span{ko(click: '$root.exitSite'), style: 'cursor:pointer'} Cancel
  <!-- /ko -->

  -# Show Site form
  <!-- ko if: showSite -->
  %form{ko(with: :showSite, submit: '$root.saveSite'), action: '#/null', method: :post, style: 'display:inline;width:100%'}
    .tableheader.w40
      %button.pback{ko(click: '$root.exitSite'), type: 'button'}
      %span.i18b-groupChat
      %span{ko(text: :name)}
    .tablescroll
      %table{style: 'width:100%'}
        %tbody
          %tr
            %td
              %div{style: 'margin-bottom:14px'}
                %label Name:
                %span.value{ko(text: :name, visible: '!editingName()', click: 'editName'), style: 'cursor: pointer'}
                <!-- ko if: editingName() -->
                = ko_text_field_tag :name, visible: 'editingName()', hasfocus: true, event: {keydown: :nameKeyPress, blur: :saveName}
                <!-- /ko -->
              %div{style: 'margin-bottom:14px'}
                %label Location:
                <!-- ko if: !hasLocation() -->
                %span.value{ko(visible: '!editingLocation()', click: 'editLocation'), style: 'color:grey;cursor:pointer'} (no value)
                <!-- /ko -->
                <!-- ko if: hasLocation() && !editingLocation() -->
                %span.value{ko(text: :locationText, visible: '!editingLocation()', click: 'editLocation'), style: 'cursor: pointer'}
                <!-- /ko -->
                <!-- ko if: editingLocation() -->
                = ko_text_field_tag :locationText, visible: :editingLocation, hasfocus: true, event: {keydown: :locationKeyPress, blur: :saveLocation}, html: {class: 'ux-search'}
                <!-- /ko -->
              - if Settings.mobile_id?
                %div{style: 'margin-bottom:14px'}
                  %label ID With Prefix:
                  %span.value{ko(text: :idWithPrefix), style: 'cursor: pointer'}
              / ko if: collection.readable($data)
              <!-- ko foreach: collection.layers -->
              / col = collection
              %div.coldiv{ko(css: {coldiv: '!expanded()', expdiv: 'expanded()'}), style: 'margin-top:24px;margin-bottom:14px'}
                %span{ko(text: :name, click: :toggleExpand), style: 'font-weight:bold;color:grey;cursor:pointer'}
              <!-- ko if: expanded() -->
              <!-- ko foreach: fields -->
              %div{style: 'margin-bottom:14px'}
                %label{ko(text: "name + '(' + code + '):'")}
                <!-- ko if: hasValue() -->
                <!-- ko if: writeable -->
                %span.value{ko(text: :valueUI, visible: '!editing()', click: 'edit'), style: 'cursor:pointer'}
                <!-- /ko -->
                <!-- ko if: !writeable -->
                %span.value{ko(text: :valueUI)}
                <!-- /ko -->
                <!-- ko if: kind == 'site' && !editing() -->
                %button.farrow.right{ko(click: 'function(data, event) { $root.editSiteFromId(value(),$root.currentCollection().id) }'), type: "button"}
                <!-- /ko -->
                <!-- /ko -->
                <!-- ko if: !hasValue() -->
                <!-- ko if: writeable -->
                %span.value{ko(visible: '!editing()', click: 'edit'), style: 'color:grey;cursor:pointer'} (no value)
                <!-- /ko -->
                <!-- ko if: !writeable -->
                %span.value{style: 'color:grey'} (no value)
                <!-- /ko -->
                <!-- /ko -->
                <!-- ko if: editing() -->
                - Field::Kinds.each do |kind|
                  <!-- ko if: kind == '#{kind}' -->
                  = render partial: field_edit_view(kind), locals: { single_editing_mode: true }
                  <!-- /ko -->
                <!-- /ko -->
              <!-- /ko -->
              <!-- /ko -->
              <!-- /ko -->
              / /ko
    <!-- ko if: !$root.currentSnapshot() -->
    .tablebottom
      = link_to 'Edit Site', 'javascript:void()', class: 'icon fedit black', 'data-bind' => kov(click: 'startEditMode')
      = link_to 'Delete Site', 'javascript:void()', class: 'icon fdelete black', 'data-bind' => kov(click: '$root.deleteSite')
    <!-- /ko -->

  <!-- /ko -->
  <!-- /ko -->

  -# Loading Site...
  %form{ko(visible: :loadingSite)}
    .tableheader.w40
      %button.pback
      %span.i18b-groupChat
      %span Loading...
#right-panel.right
  .mapheader
    <!-- ko if: $root.currentCollection() -->
    .greyback
      %span{style: 'margin:0;padding:2px;display:inline-block'}
        Export this result in
        %span{ko(click: :exportInRSS), style: 'text-decoration:underline;cursor:pointer;margin:0'} RSS
        ,
        %span{ko(click: :exportInJSON), style: 'text-decoration:underline;cursor:pointer;margin:0'} JSON
        or
        %span{ko(click: :exportInCSV), style: 'text-decoration:underline;cursor:pointer;margin:0'} CSV
    <!-- /ko -->
    %span{ko(text: :sitesCountText)}
    - Plugin.all.each do |plugin|
      = render_plugin_hook plugin, :map_header
    %button.icon_button.ffullscreen.right{ko(click: '$root.tooglefullscreen') }
    %button.icon_button.ftable.right{ko(click: '$root.showTable', css: {active: "!$root.showingMap()"})}
    %button.icon_button.fmap.right{ko(click: '$root.showMap', css: {active: "$root.showingMap()"})}
    %br{clear: :all}
  %div.mapcontainer
    %button.icon_button.expand-collapse_button.oleftexpand{ko(click: '$root.toogleExpandFullScreen')}
    <!-- ko if: $root.shouldShowLocationMissingAlert() -->
    %a#sites_whitout_location_alert.alert.box.flash_error.drop_shadow(href='javascript:window.model.filterByLocationMissing()')
      %span{ko(text: :locationMissingAlertText)}
      %span.right
        %button.fconfiguration{ko(click: '$root.filterByLocationMissing'), type: 'button', style: 'margin-left:9px'}
        %span.black{ko(text: :showThemText)}
      .clear
    <!-- /ko -->
    #map


